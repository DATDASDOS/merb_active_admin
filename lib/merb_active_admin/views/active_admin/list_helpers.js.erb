// Populate other association tables when the main table is clicked
function clickedMainTableRow(gridName) {
  var ids = getSelectedIDs("#table_" + gridName);

  $(".associate_context").hide();
  $(".disassociate_context").show();
  
  // Loop through each flexigrid table that is NOT the main table, and
  // reload the data now that we have an object to show associations for
  $(".table_association").each(function(i, grid_element) {
    if (ids.length > 0) {
      grid_element.p.generateUrl(ids[0]);
      grid_element.grid.populate();
    }
  });
}

function getSelectedIDs(wrapper) {
  var ids = [];
  var rows = (wrapper ? wrapper + " " : "") + ".trSelected";
  $(rows).each(function(i, row) {
    var match = row.id.match(/row(\d+)/)
    if( match ) ids.push(match[1]);
  });
  return ids;
}

// Give instructions if necessary, or go on to delete
function attemptDelete(tableName) {
  var ids = getSelectedIDs("#main_wrapper");

  // Global variable just for facebox
  faceboxTableName = tableName;
  if( ids.length == 0 ) {
    $.facebox("Select one or more rows to delete, then click this 'Delete' button.");
  } else {
    $.facebox($('#confirm_delete_rows_box'));
  }
}

// Actually do the ajax call to delete rows
function deleteSelectedRows(tableName) {
  var ids = getSelectedIDs("#table_" + tableName);
  var url = "<%= active_admin_home_url %>/" + tableName + "/destroy/" + ids.join(",");
  $.post(url, null, null, "json");
  $("#table_" + tableName).flexReload();
}

// Give instructions if necessary, or go on to edit
function attemptEdit(tableName) {
  var ids = getSelectedIDs("#table_" + tableName);
  if( ids.length == 1 ) {
    window.location = "<%= active_admin_url(:edit) %>/" + ids[0];
  } else {
    $.facebox(
      "Select " + (ids.length == 0 ? "a" : "only one") +
      " row, and then click the 'Edit' button.");
  }
}

// Give instructions if necessary, or go on to associate
function attemptAssociate(controller, association) {
  var ids = getSelectedIDs("#table_" + association);
  if( ids.length == 0 ) {
    $.facebox("Select one or more rows to associate, then click the 'Associate' button.");
  } else {
    associateSelectedRows(controller, association, ids);
  }
}

function associateSelectedRows(controller, association, ids) {
  var mainIds = getSelectedIDs("#main_wrapper");
  if (mainIds.length > 0) {
    var mainId = mainIds[0];
    var url = "/<%= active_admin_module %>/" + controller +
              "/" + mainId + "/associate/" + association + "/" + ids.join(",");
    $.post(url, function() { showAssociatedOnly(association) }, null, "json");
  } else {
    $.facebox("Main object not selected");
  }
}


// Give instructions if necessary, or go on to disassociate
function attemptDisassociate(controller, association) {
  var ids = getSelectedIDs("#table_" + association);
  if( ids.length == 0 ) {
    $.facebox("Select one or more rows to disassociate, then click the 'Disassociate' button.");
  } else {
    disassociateSelectedRows(controller, association, ids);
  }
}

function disassociateSelectedRows(controller, association, ids) {
  var mainIds = getSelectedIDs("#main_wrapper");
  if (mainIds.length > 0) {
    var mainId = mainIds[0];
    var url = "/<%= active_admin_module %>/" + controller +
              "/" + mainId + "/disassociate/" + association + "/" + ids.join(",");
    $.post(url, function() { showAssociatedOnly(association) }, null, "json");
  } else {
    $.facebox("Main object not selected");
  }
}

function showAll(name) {
  // We're going to show all objects in the table, so show the ASSOCIATE tools
  $("#" + name + "_wrapper .associate_context").show();
  $("#" + name + "_wrapper .disassociate_context").hide();

  // Set the URL to normal data list and reload
  $("#table_" + name).flexOptions({
    url: "/" +
      "<%= active_admin_module %>/" +
      name + "/" + "list_data"
  });
  $("#table_" + name).flexReload();
}

function showAssociatedOnly(name) {
  var ids = getSelectedIDs("#main_wrapper");

  if (ids.length > 0) {
    // We're going to show only associated objects in the table, so show the DISASSOCIATE tools
    $("#" + name + "_wrapper .associate_context").hide();
    $("#" + name + "_wrapper .disassociate_context").show();
  
    // Set the URL to list associated data and reload
    $("#table_" + name)[0].p.generateUrl(ids[0]);
    $("#table_" + name).flexReload();
  }
}
